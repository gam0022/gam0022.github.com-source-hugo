+++
image = "/images/posts/2020-04-19-revision2020/resimulated-collage.jpg"
toc = true
math = false
draft = false
tags = ["event", "CG", "レイマーチング", "Revision", "WebGL", "GLSL", "TypeScript", "JavaScript"]
title = "Revision2020 PC 64K Intro 優勝作品『RE: SIMULATED』の技術解説"
slug = "revision2020"
date = "2020-04-19T20:31:34+09:00"

+++

4月10日～4月13日に開催された世界最大のデモパーティ[Revision2020](https://2020.revision-party.net/start)に参加して、『RE: SIMULATED by gam0022 & sadakkey』という作品を発表しました。

本作品が[PC 64K Intro](https://2020.revision-party.net/competitions/pc-competitions)という64KBの容量制限のある部門で参加者投票により1位に選ばれて優勝しました！

映像は私（[@gam0022](https://twitter.com/gam0022)）、音楽はさだきちさん（[@sadakkey](https://twitter.com/sadakkey)）の担当で制作しました。

![resimulated-collage](/images/posts/2020-04-19-revision2020/resimulated-collage.jpg)

<!--more-->

# 作品紹介

WebGLとWebAudioによる64K Introなので、最新のChromeと高性能なGPUがあれば、ブラウザ上で動作します。

- [64KB HTML version](https://gam0022.net/webgl/64k-intro_resimulated.html)
- [NEORT version](https://neort.io/art/bqa4pgs3p9f6qoqnmujg)

26KBの単一のHTMLファイルだけで完全に動作するデモとなっています。

今回が64K部門のエントリーは初めてということもあり、どのくらいのコンテンツが詰め込めるか感覚がつかめず、うまく調整できずに容量を半分以上も余らせてしまいました…

<blockquote class="twitter-tweet" data-conversation="none"><p lang="ja" dir="ltr">実は26KBしか使いきれなかったので、次回は64KBギリギリまで使えるように精進します💪 <a href="https://t.co/uxF2M5DZmg">pic.twitter.com/uxF2M5DZmg</a></p>&mdash; がむ / encoder killer (@gam0022) <a href="https://twitter.com/gam0022/status/1249677712815321088?ref_src=twsrc%5Etfw">April 13, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

スペックの高いPCを持っていない方は、YouTubeの動画をご覧ください。

フラクタルをつかった映像のビットレートの高い作品ですが、4K解像度を選ぶことである程度は綺麗な状態で見れます。

<div class="movie-wrap">
<iframe width="1920" height="1080" src="https://www.youtube.com/embed/tirAdWbceak" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

---

こちらはpouet（デモシーンのコミュニティサイト）のリンクです。

- [RE: SIMULATED by Gam0022 &amp; Sadakkey :: pouët.net](https://www.pouet.net/prod.php?which=85260)

## Revisionとは

2020年現在、世界最大規模のデモパーティです。

例年ドイツで開催されていましたが、[今年はコロナウイルスの影響で完全オンラインでの開催](https://2020.revision-party.net/cancellation)となりました。

しかし、そんな中でも[世界中から1610人が参加](https://2020.revision-party.net/about/visitors)する大規模なイベントになりました。

## 今年のPC 64K Intro部門

日本人のチームがPC 64K Intro部門で優勝するのは Revision 史上初です。

去年のPC 64K Introは本当にレベルが高かったのですが、今年は優勝候補チームが他の部門に分散したために、競争相手が少なかったので自分のレベルでも優勝できたという感じです。

自分の作品だけを見てPC 64K Introのレベルを判断されるのは本意ではないので、去年のPC 64K Introの優勝作品のYouTubeのリンクを紹介しておきます。これが本来のPC 64K Introのレベルです！

- [Dope on Wax by Logicoma (PC 64k) [party version]](https://youtu.be/QhqT0DhV9yE)

実力ではなく運で優勝してしまったのですが、尊敬するデモチームの方々にたくさんの称賛のコメントをいただけたので、とても光栄に思います！

そもそも優勝するとは微塵にも思っておらず、海外勢にも少しでも名前を覚えてもらえたら嬉しいなぁくらいのノリでエントリーしたのに、まさか優勝してしまうとは…

# 技術解説

さて、ここから本題の技術解説に入っていきます。

ソースコードはすべてGitHubに公開しているので、興味がある方はぜひ見てください。

- [gam0022/resimulated: 1st place at Revision 2020 (PC 64K Intro)](https://github.com/gam0022/resimulated)

キーワードとしては、以下の技術が使われています。

TypeScript, WebGL, WebAudio, webpack, pnginator.rb, Raymarching, GLSL Sound

## シンプルなWebGLエンジン『Chromatiq』

64KBの容量制約があるため、Unityやthree.jsといった既存のゲームエンジンやフレームワークを利用せずに、描画用のWebGLエンジンと制作用のツール（エディタ機能）を自作する必要がありました。

OpenGLやDirectXを使わずに、WebGLを選択した理由は以下です。

- WebGLでブラウザ上で動かせれば、手元のPCで動かしてもらえる可能性が高いと考えた
    - 自分の作品は映像のビットレートが高く、動画だと綺麗にならないため、手元のPCで実行して見てもらいたい
- Webフロントエンドの技術をキャッチアップしたかった
    - 業務ではUnityしか触る機会がない

そこで、64K Intro向けにファイルサイズの最小化を目的としたシンプルなWebGLエンジンである『Chromatiq』を開発しました。

WebGLエンジンとは言うものの、本当にシンプルで最小限な機能しか "現段階では" 実装していません。

なるべく作品に依存した機能は用意したくなかったので、汎用的な設計になっています。

- マルチパスのImageShaderによるレンダリング（viewport square）
- ビルドインのBloomのポストエフェクト
    - どんな作品でも利用できそうなので、これだけビルドインにした
- TypeScriptからuniformをアニメーションするためのインターフェース
- Shadertoyと互換性のあるGLSL Sound
- オーディオファイルの再生（mp3 / ogg）
    - 今回は先にDAWで作曲し、後からGLSLに移植する作戦にしたので、DAWによる音楽の再生用の機能
- フォントをレンダリングするためのcanvasからのテクスチャ生成

イメージとしてはGLSLエディタを排除したスタンドアローンなShadertoyが近いかもしれません。

ソースコードは[こちら](https://github.com/gam0022/resimulated/blob/master/src/chromatiq.ts)です。単一ファイルのTypeScriptで実装しました。

圧縮後のコードサイズを気にして、変な感じの実装になっているので、微妙に読みづらいかもしれません。

例えば、フィールド参照の this を頭につけるとコードサイズが増えるため、コンストラクタの中で動的にインスタンスメソッドを定義することで、this の利用を最小限にしたり、
クラス外から値を参照・設定する必要があるデータのみ、フィールドとして定義する方針とています。enumもコードサイズが増えるので禁止にしました。

製作の終盤から容量が余裕そうなことが判明したので、途中からファイルサイズを考慮するのを止め、mini化の中途半端感は否めないです。
このあたりは、次のデモに向けて改良していきたいと考えています。

uniform名は基本的にはShadertoyと一致させているのですが、テクスチャのサンプラーはShadertoyを踏襲せずに、直前のパスを参照する `iPrevPass` を定義しました。
これによってGLSLを書き換えずにエフェクトの順番を入れ替えたり、気軽にパスを増やしてエフェクトをチェインしやすくしました。
このあたりの仕様も、作品の需要に応じて変更していく可能性は高いです。

## 開発用のエディタ機能

動画を貼りたい…

## ファイル圧縮のためのビルドプロセス

圧縮には[webpack](https://webpack.js.org/)と[pnginator.rb](https://gist.github.com/gasman/2560551)を利用しています。

ビルドプロセスを図にしました。

![build-process](/images/posts/2020-04-19-revision2020/build-process.svg)

webpackですべてのファイルをbundle.jsという単一のJavaScriptに固めてから、pnginator.rbで自己解凍形式のPNGにしています。

TypeScriptのminifyは完全にwebpack任せです。

pnginator.rbはgasmanさんが作ったJavaScriptを自己解凍形式のPNGにパックするツールです。

PNGでは画像データをzlib圧縮するため、画像データではなくても、例えば今回のようなプログラムのソースコードでちゃんと圧縮できます。

[GLSLのminifyも検証](https://qiita.com/gam0022/items/364c7f76f2787e385161)はしていて、webpackのLoaderを開発する予定もあったのですが、容量が余裕だったのでGLSLの圧縮はPNG（zlib）だけになりました。

また、開発用にしか必要ないコードの削除もwebpackの[define-plugin](https://webpack.js.org/plugins/define-plugin/)で実現できました。

webpackとpnginator.rbを組み合わせる手法は、FMS_Catさんの[Until](https://github.com/FMS-Cat/until/)を参考にしました。ありがとうございます！

当初はnode.jsでGLSLのホットリロード機能付きのWebサーバを開発しようと技術検証していたのですが、
要件は[webpack-dev-server](https://github.com/webpack/webpack-dev-server)ですべて実現可能だったので、webpackを採用しました。

## 映像について

## サウンド用のシーケンサー

## RE: SIMULATED の意味

# おわりに